
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Installation and setup &#8212; CASA-Distro - BrainVisa / CATI development distribution</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Using the casa_distro_admin command" href="casa_distro_admin_command.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="casa_distro_admin_command.html" title="Using the casa_distro_admin command"
             accesskey="P">previous</a></li>
        <li class="nav-item nav-item-0"><a href="index.html">CASA-Distro</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Installation and setup</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="installation-and-setup">
<h1>Installation and setup<a class="headerlink" href="#installation-and-setup" title="Permalink to this headline">¶</a></h1>
<div class="section" id="setting-up-docker">
<h2>Setting up Docker<a class="headerlink" href="#setting-up-docker" title="Permalink to this headline">¶</a></h2>
<div class="section" id="install-and-use-docker-on-an-ubuntu-host">
<h3>Install and use docker on an Ubuntu host<a class="headerlink" href="#install-and-use-docker-on-an-ubuntu-host" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>Install docker using apt-get :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt-get install docker.io
</pre></div>
</div>
</li>
<li><p>To enable users other than root and users with sudo access to be able to run Docker commands:</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Users who can run Docker commands have effective root control of the system. Only grant this privilege to trusted users.</p>
</div>
<p>The following procedure applies to version 1.5 and later of Docker.</p>
<ol class="arabic simple">
<li><p>Create the <code class="docutils literal notranslate"><span class="pre">docker</span></code> group (maybe group <code class="docutils literal notranslate"><span class="pre">docker</span></code> already exists):</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo groupadd docker
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Restart the docker service:</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo service docker restart
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>For some os system version (Ubuntu 14.04-15.10) use <strong>docker.io</strong> instead of <strong>docker</strong></p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The UNIX socket <code class="docutils literal notranslate"><span class="pre">/var/run/docker.sock</span></code> is now readable and writable by members of the docker group.</p>
</div>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><p>Add the users that should have Docker access to the docker group:</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo usermod -a -G docker &lt;username&gt;
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="4">
<li><p>logout / login to update groups cache</p></li>
</ol>
<blockquote>
<div><p>Or use the following command to open a new shell forcing to take group updates into account:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo su &lt;login&gt;
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="change-docker-s-storage-base-directory">
<span id="change-docker-base-dir"></span><h3>Change Docker’s storage base directory<a class="headerlink" href="#change-docker-s-storage-base-directory" title="Permalink to this headline">¶</a></h3>
<p>By default, docker images are stored in will be <code class="docutils literal notranslate"><span class="pre">/var/lib/docker/aufs</span></code> but can fall back to <code class="docutils literal notranslate"><span class="pre">btrfs</span></code>, <code class="docutils literal notranslate"><span class="pre">devicemapper</span></code> or <code class="docutils literal notranslate"><span class="pre">vfs</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/var/lib/docker/{driver-name}</span></code> will contain the driver specific storage for contents of the images.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/var/lib/docker/graph/</span></code> now only contains metadata about the image, in the <code class="docutils literal notranslate"><span class="pre">json</span></code> and <code class="docutils literal notranslate"><span class="pre">layersize</span></code> files.</p></li>
</ul>
<p>In the case of aufs:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/var/lib/docker/aufs/diff/</span></code> has the file contents of the images.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/var/lib/docker/repositories-aufs</span></code> is a JSON file containing local image information. This can be viewed with the command <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">images</span></code>.</p></li>
</ul>
<ol class="arabic simple">
<li><p>First method</p></li>
</ol>
<blockquote>
<div><p>You can change Docker’s storage base directory (where container and images go) using the <code class="docutils literal notranslate"><span class="pre">-g</span></code> option when starting the Docker daemon.
You must to stop docker:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo service docker stop
</pre></div>
</div>
<p>Create a new directory for docker:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo mkdir /mnt/docker
</pre></div>
</div>
</div></blockquote>
<blockquote id="dns-setup">
<div><ul>
<li><p>Ubuntu/Debian: edit your <code class="docutils literal notranslate"><span class="pre">/etc/default/docker</span></code> file with the <code class="docutils literal notranslate"><span class="pre">-g</span></code> option:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">DOCKER_OPTS</span><span class="o">=</span><span class="s2">&quot;-dns 8.8.8.8 -dns 8.8.4.4 -g /mnt/docker&quot;</span> <span class="c1"># (or write it if the line doesn&#39;t exist in this file)</span>
</pre></div>
</div>
</li>
<li><p>Fedora/Centos: edit <code class="docutils literal notranslate"><span class="pre">/etc/sysconfig/docker</span></code>, and add the <code class="docutils literal notranslate"><span class="pre">-g</span></code> option in the <code class="docutils literal notranslate"><span class="pre">other_args</span></code> variable: ex.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">other_args</span><span class="o">=</span><span class="s2">&quot;-g /var/lib/ testdir&quot;</span>.
</pre></div>
</div>
<p>If there’s more than one option, make sure you enclose them in <code class="docutils literal notranslate"><span class="pre">&quot;</span> <span class="pre">&quot;</span></code>.</p>
</li>
</ul>
<p>Docker should use the new directory after a restart:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo service docker start
</pre></div>
</div>
<p>You can check it using:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker info
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Second method (Using a symlink)</p></li>
</ol>
<blockquote>
<div><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>These steps depend on your current /var/lib/docker being an actual directory (not a symlink to another location).</p>
</div>
<ol class="arabic simple">
<li><p>Stop docker:</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>service docker stop.
</pre></div>
</div>
<p>Verify no docker process is running:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ps faux
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Double check docker really isn’t running. Take a look at the current docker directory:</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ls /var/lib/docker/
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><p>Make a backup:</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tar -zcC /var/lib docker &gt; /mnt/pd0/var_lib_docker-backup-<span class="k">$(</span>date +%s<span class="k">)</span>.tar.gz
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="4">
<li><p>Move the /var/lib/docker directory to your new partition:</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mv /var/lib/docker /mnt/pd0/docker
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="5">
<li><p>Make a symlink:</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ln -s /mnt/pd0/docker /var/lib/docker
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="6">
<li><p>Take a peek at the directory structure to make sure it looks like it did before the <code class="docutils literal notranslate"><span class="pre">mv</span></code>:</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ls /var/lib/docker/
</pre></div>
</div>
<p>(note the trailing slash to resolve the symlink)</p>
</div></blockquote>
<ol class="arabic simple" start="7">
<li><p>Start docker back up service</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker start
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="8">
<li><p>restart your containers</p></li>
</ol>
</div></blockquote>
</div>
</div>
<div class="section" id="overview-of-the-existing-public-brainvisa-images">
<h2>Overview of the existing public brainvisa images<a class="headerlink" href="#overview-of-the-existing-public-brainvisa-images" title="Permalink to this headline">¶</a></h2>
<p>To search available images on docker hub (example with ubuntu) :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker search --stars<span class="o">=</span><span class="m">10</span> ubuntu
</pre></div>
</div>
<p>or using this url: <a class="reference external" href="https://hub.docker.com">https://hub.docker.com</a></p>
<ul class="simple">
<li><p>An open source brainvisa repository is available on docker hub: <a class="reference external" href="https://hub.docker.com/r/cati">https://hub.docker.com/r/cati</a></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is a public repository !</p>
</div>
<ul>
<li><p><strong>cati/casa-test</strong> image</p>
<p>Minimal OS system to test a package of brainvisa in lambda-user conditions.</p>
<p>Just some libraries are installed to run a X server and to test the creation of snapshots.</p>
<p>Several images:</p>
<ol class="arabic simple">
<li><p>Ubuntu 12.04</p></li>
<li><p>Ubuntu 16.04</p></li>
<li><p>windows-7-32: Ubuntu 14.04 + Wine for windows-7-32</p></li>
<li><p>windows-7-64: Ubuntu 14.04 + Wine for windows-7-64</p></li>
</ol>
</li>
<li><p><strong>cati/casa-dev</strong> image</p>
<p>Based on <code class="docutils literal notranslate"><span class="pre">cati/casa-test</span></code> image.</p>
<p>Include all system dependencies (using <code class="docutils literal notranslate"><span class="pre">apt</span> <span class="pre">get</span></code>) to run a compilation of brainvisa and Qt Installer Framework to create a brainvisa package.</p>
<p>These images are dedicated for developers.</p>
<p>Several images:</p>
<ol class="arabic simple">
<li><p>Ubuntu 12.04</p></li>
<li><p>Ubuntu 16.04</p></li>
<li><p>windows-7-32: Ubuntu 14.04 + Wine for windows-7-32</p></li>
<li><p>windows-7-64: Ubuntu 14.04 + Wine for windows-7-64</p></li>
</ol>
</li>
</ul>
</div>
<div class="section" id="how-to-use-a-docker-image">
<h2>How to use a docker image<a class="headerlink" href="#how-to-use-a-docker-image" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>Get docker image:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker pull cati/casa-test:ubuntu-12.04
</pre></div>
</div>
<p>Examples with other cati images in docker hub :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker pull cati/casa-test:ubuntu-16.04
docker pull cati/casa-dev:ubuntu-12.04
docker pull cati/casa-dev:ubuntu-16.04
</pre></div>
</div>
</li>
<li><p>Run a docker image:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker run -it --rm cati/casa-dev:ubuntu-16.04-bug_fix /bin/bash
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="cleaning-up-docker">
<span id="id1"></span><h2>Cleaning up docker<a class="headerlink" href="#cleaning-up-docker" title="Permalink to this headline">¶</a></h2>
<div class="section" id="containers">
<h3>Containers<a class="headerlink" href="#containers" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>Remove exited containers</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker ps --filter <span class="nv">status</span><span class="o">=</span>dead --filter <span class="nv">status</span><span class="o">=</span>exited -aq <span class="p">|</span> xargs -r docker rm -v
</pre></div>
</div>
</li>
<li><p>Remove older containers (example: 2 weeks or more)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker ps --filter <span class="s2">&quot;status=exited&quot;</span> <span class="p">|</span> grep <span class="s1">&#39;weeks ago&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span> <span class="p">|</span> xargs --no-run-if-empty sudo docker rm
</pre></div>
</div>
</li>
<li><p>Remove all containers</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker rm <span class="k">$(</span>docker ps -a -q<span class="k">)</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="images">
<h3>Images<a class="headerlink" href="#images" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>Remove an image:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ docker images
REPOSITORY                  TAG                    IMAGE ID            CREATED             VIRTUAL SIZE
cati/casa-dev       ubuntu-12.04           7c1691e1e9d1        <span class="m">2</span> days ago          <span class="m">2</span>.264 GB
</pre></div>
</div>
<p>To know the id of the image to remove…</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker rmi 7c1691e1e9d1
</pre></div>
</div>
<p>To remove <code class="docutils literal notranslate"><span class="pre">cati/casa-dev</span></code>.</p>
<p>If one or more containers are using the image, use the option <code class="docutils literal notranslate"><span class="pre">-f</span></code> to force the command <code class="docutils literal notranslate"><span class="pre">rmi</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker rmi -f 7c1691e1e9d1
</pre></div>
</div>
</li>
<li><p>Remove unused images</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker images --no-trunc <span class="p">|</span> grep <span class="s1">&#39;&lt;none&gt;&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;{ print $3 }&#39;</span> <span class="p">|</span> xargs -r docker rmi
</pre></div>
</div>
</li>
<li><p>Remove all images</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker rmi <span class="k">$(</span>docker images -q<span class="k">)</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="how-to-change-the-development-environment">
<h2>How to change the development environment ?<a class="headerlink" href="#how-to-change-the-development-environment" title="Permalink to this headline">¶</a></h2>
<p>To add an external library, modify the Dockerfile of <code class="docutils literal notranslate"><span class="pre">casa-dev</span></code> for ubuntu-12.04 or ubuntu-16.04:</p>
<div class="highlight-dockerfile notranslate"><div class="highlight"><pre><span></span><span class="c"># Dockerfile for image cati/casa-dev:ubuntu-16.04</span>

<span class="k">FROM</span> <span class="s">cati/casa-test:ubuntu-16.04</span>

<span class="k">USER</span><span class="s"> root</span>

<span class="c"># Install system dependencies</span>
<span class="k">RUN</span> apt-get install -y <span class="se">\</span>
    build-essential <span class="se">\</span>
    <span class="o">(</span>...<span class="o">)</span>
    liblapack-dev <span class="se">\</span>
    &lt;your_library&gt; <span class="se">\ </span> ###### HERE INSERT THE NAME OF THE EXTERNAL LIBRARY
  <span class="o">&amp;&amp;</span> apt-get clean

<span class="c"># Install Qt Installer Framework</span>
<span class="k">COPY</span> qt_installer_script /tmp/qt_installer_script
<span class="k">RUN</span> wget -q http://download.qt.io/official_releases/qt-installer-framework/2.0.3/QtInstallerFramework-linux-x64.run -O /tmp/QtInstallerFramework-linux-x64.run <span class="o">&amp;&amp;</span> <span class="se">\</span>
    chmod +x /tmp/QtInstallerFramework-linux-x64.run <span class="o">&amp;&amp;</span> <span class="se">\</span>
    xvfb-run /tmp/QtInstallerFramework-linux-x64.run --script /tmp/qt_installer_script <span class="o">&amp;&amp;</span> <span class="se">\</span>
    ln -s /usr/local/qt-installer/bin/* /usr/local/bin/ <span class="o">&amp;&amp;</span> <span class="se">\</span>
    rm /tmp/QtInstallerFramework-linux-x64.run /tmp/qt_installer_script

<span class="o">(</span>...<span class="o">)</span>

<span class="c">###### OR WRITE THE COMMAND LINES TO INSTALL THE LIBRARY FROM SOURCES</span>

<span class="k">USER</span><span class="s"> brainvisa</span>
</pre></div>
</div>
<p>After, run the script called create_images (<code class="docutils literal notranslate"><span class="pre">[sources]/casa-distro/[trunk|bug_fix]/docker/create_images</span></code>).</p>
<p>This script will rebuild <code class="docutils literal notranslate"><span class="pre">casa-test</span></code> and <code class="docutils literal notranslate"><span class="pre">casa-dev</span></code> images if the <code class="docutils literal notranslate"><span class="pre">Dockefile</span></code> was modified and will push all images in docker hub.</p>
<p>In our example, only the <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> of <code class="docutils literal notranslate"><span class="pre">casa-dev</span></code> is different, so only <code class="docutils literal notranslate"><span class="pre">casa-dev</span></code> image will rebuilt.</p>
<p>The aim of a registry server for docker is to share private images of brainvisa for CATI members.
.. Create the registry on <a class="reference external" href="https://catidev.cea.fr">https://catidev.cea.fr</a> is more complicated due to CEA retrictions, so we use <a class="reference external" href="https://sandbox.brainvisa.info">https://sandbox.brainvisa.info</a>.</p>
<p>The Registry is compatible with Docker engine version 1.6.0 or higher.</p>
<p>In progress….</p>
<p>To update from changes in the image on server:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker pull is208614:5000/casa/system
</pre></div>
</div>
</div>
<div class="section" id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h2>
<p>Typical problems are listed here.</p>
<div class="section" id="system-disk-full">
<h3>System disk full<a class="headerlink" href="#system-disk-full" title="Permalink to this headline">¶</a></h3>
<p>Docker images are big, and may grow bigger…</p>
<ul class="simple">
<li><p><a class="reference internal" href="#change-docker-base-dir"><span class="std std-ref">Change the filesystem / disk for docker images</span></a></p></li>
<li><p><a class="reference internal" href="#cleaning-up-docker"><span class="std std-ref">cleanup leftover docker images or containers</span></a></p></li>
</ul>
</div>
<div class="section" id="cannot-build-docker-image-network-access-denied">
<h3>Cannot build docker image, network access denied<a class="headerlink" href="#cannot-build-docker-image-network-access-denied" title="Permalink to this headline">¶</a></h3>
<p>With Docker versions older than 1.13, the <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">build</span></code> command did not have a host networking option. On some systems (Ubuntu 14 for instance) the contents of <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> point to a local proxy DNS server (at least that’s what I understand), and docker could not use it during image building.</p>
<p>Either upgrade to a newer Docker, or change the <a class="reference internal" href="#dns-setup"><span class="std std-ref">DNS setup</span></a> for Docker.</p>
</div>
<div class="section" id="cannot-mount-ssh-id-rsa-when-starting-docker">
<h3>Cannot mount <code class="docutils literal notranslate"><span class="pre">~/.ssh/id_rsa</span></code> when starting docker<a class="headerlink" href="#cannot-mount-ssh-id-rsa-when-starting-docker" title="Permalink to this headline">¶</a></h3>
<p>When docker starts, even when running as a specific user, it starts up as root. The mount options specified on docker commandline are setup as root. If the user home directory is on a network filesystem (NFS…), the local root user cannot override the filesystem access rights. Thus the directory tree must be traversable to reach the mounted directory.</p>
<p>In other words, the <code class="docutils literal notranslate"><span class="pre">+x</span></code> flag has to be set for “other” users on the directory and its parents. Typically:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>chmod o+x ~
chmod o+x ~/.ssh
</pre></div>
</div>
</div>
<div class="section" id="opengl-is-not-working-or-is-slow">
<span id="opengl-troubleshooting"></span><h3>OpenGL is not working, or is slow<a class="headerlink" href="#opengl-is-not-working-or-is-slow" title="Permalink to this headline">¶</a></h3>
<div class="section" id="with-docker">
<h4>with docker<a class="headerlink" href="#with-docker" title="Permalink to this headline">¶</a></h4>
<p>Several options are needed to enable display and OpenGL. Normally casa_distro tries to set them up and should do the best it can.</p>
<p>On machines with nvidia graphics cards and nvidia proprietary drivers, casa_distro will add options to mount the host system drivers and OpenGL libraries into the container in order to have hardware 3D rendering.</p>
<p>Options are setup in the <code class="docutils literal notranslate"><span class="pre">casa_distro.json</span></code> file so you can check and edit them. Therefore, the detection of nvidia drivers is done on the host machine at the time of build workflow creation: if the build workflow is shared accross several machines on a network, this config may not suit all machines running the container.</p>
<p>However it does not seem to work when ssh connections and remote display are involved.</p>
</div>
<div class="section" id="with-singularity">
<h4>with singularity<a class="headerlink" href="#with-singularity" title="Permalink to this headline">¶</a></h4>
<p>By default OpenGL runs using a software Mesa library. It should work in “most” cases, but in a slow manner. On machines with nvidia graphics cards and nvidia proprietary drivers, singularity has an option <code class="docutils literal notranslate"><span class="pre">&quot;--nv&quot;</span></code> to handle it. Casa-distro will try to detect nvidia drivers, and if they are found, will set this option. Contrarily to the docker case above, this detection is done each time a container is started, and the option is hard-coded in options passed by casa_distro to singularity (not editable in the config file).</p>
<p>There are cases where adding the nvidia option makes things worse (see ssh connections below). If you ever need to disable the nvidia option, you can add an option <code class="docutils literal notranslate"><span class="pre">container_options=--no-nv</span></code> to <code class="docutils literal notranslate"><span class="pre">run</span></code>, <code class="docutils literal notranslate"><span class="pre">shell</span></code> and other subcommands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>casa_distro run <span class="nv">container_options</span><span class="o">=</span>--no-nv glxinfo
</pre></div>
</div>
<p>If it is OK, you can set this option in the build workflow <code class="docutils literal notranslate"><span class="pre">casa_distro.json</span></code> config, under the <code class="docutils literal notranslate"><span class="pre">&quot;container_gui_env&quot;</span></code> key:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">{</span>
    <span class="s2">&quot;container_env&quot;</span>: <span class="o">{</span>
    <span class="c1"># ...</span>
    <span class="o">}</span>,
    <span class="s2">&quot;system&quot;</span>: <span class="s2">&quot;ubuntu-16.04&quot;</span>,
    <span class="s2">&quot;distro_source&quot;</span>: <span class="s2">&quot;brainvisa&quot;</span>,
    <span class="s2">&quot;container_gui_env&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;DISPLAY&quot;</span>: <span class="s2">&quot;</span><span class="si">${</span><span class="nv">DISPLAY</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="o">}</span>,
    <span class="s2">&quot;container_mounts&quot;</span>: <span class="o">{</span>
    <span class="c1"># ...</span>
    <span class="o">}</span>,
    <span class="c1"># ...</span>
    <span class="s2">&quot;container_options&quot;</span>: <span class="o">[</span>
        <span class="s2">&quot;--pwd&quot;</span>,
        <span class="s2">&quot;/casa/home&quot;</span>
    <span class="o">]</span>,
    <span class="s2">&quot;container_gui_env&quot;</span>: <span class="o">[</span>
        <span class="s2">&quot;--no-nv&quot;</span>
    <span class="o">]</span>,
    <span class="c1"># ...</span>
<span class="o">}</span>
</pre></div>
</div>
<dl>
<dt>Via a ssh connection:</dt><dd><dl>
<dt>same host, different user:</dt><dd><p><code class="docutils literal notranslate"><span class="pre">xhost</span> <span class="pre">+</span></code> must have been used on the host system. Works (as long as
the <code class="docutils literal notranslate"><span class="pre">XAUTHORITY</span></code> env variable points to the <code class="docutils literal notranslate"><span class="pre">.Xauthority</span></code> file from
the host user home directory).</p>
</dd>
<dt>different host:</dt><dd><p>I personally could not make it work using the <code class="docutils literal notranslate"><span class="pre">--nv</span></code> option. But
actually outside of casa-distro or any container, it doesn’t work
either. Remote GLX rendering has always been a very delicate thing…</p>
<p>It works for me using the software Mesa rendering (slow). So at this point, using casa_distro actually makes it possible to render OpenGL when the host system cannot (or not directly)…</p>
</dd>
</dl>
</dd>
</dl>
</div>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Installation and setup</a><ul>
<li><a class="reference internal" href="#setting-up-docker">Setting up Docker</a><ul>
<li><a class="reference internal" href="#install-and-use-docker-on-an-ubuntu-host">Install and use docker on an Ubuntu host</a></li>
<li><a class="reference internal" href="#change-docker-s-storage-base-directory">Change Docker’s storage base directory</a></li>
</ul>
</li>
<li><a class="reference internal" href="#overview-of-the-existing-public-brainvisa-images">Overview of the existing public brainvisa images</a></li>
<li><a class="reference internal" href="#how-to-use-a-docker-image">How to use a docker image</a></li>
<li><a class="reference internal" href="#cleaning-up-docker">Cleaning up docker</a><ul>
<li><a class="reference internal" href="#containers">Containers</a></li>
<li><a class="reference internal" href="#images">Images</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-change-the-development-environment">How to change the development environment ?</a></li>
<li><a class="reference internal" href="#troubleshooting">Troubleshooting</a><ul>
<li><a class="reference internal" href="#system-disk-full">System disk full</a></li>
<li><a class="reference internal" href="#cannot-build-docker-image-network-access-denied">Cannot build docker image, network access denied</a></li>
<li><a class="reference internal" href="#cannot-mount-ssh-id-rsa-when-starting-docker">Cannot mount <code class="docutils literal notranslate"><span class="pre">~/.ssh/id_rsa</span></code> when starting docker</a></li>
<li><a class="reference internal" href="#opengl-is-not-working-or-is-slow">OpenGL is not working, or is slow</a><ul>
<li><a class="reference internal" href="#with-docker">with docker</a></li>
<li><a class="reference internal" href="#with-singularity">with singularity</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="casa_distro_admin_command.html"
                        title="previous chapter">Using the casa_distro_admin command</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="casa_distro_admin_command.html" title="Using the casa_distro_admin command"
             >previous</a></li>
        <li class="nav-item nav-item-0"><a href="index.html">CASA-Distro</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Installation and setup</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017-2020, BrainVISA team &lt;contact@brainvisa.info&gt;.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>