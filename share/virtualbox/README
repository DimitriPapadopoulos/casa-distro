================
I - Introduction
================

To create a VirtualBox image for BrainVISA, VirtualBox with at least version 6 must be installed.

To start the custom installation and building process, we need a system base image which is a minimal desktop image, updated at the time of its creation and with a configured brainvisa account as well as VirtualBox guest additions installed. The next chapter of this document explain how to create such a base system from scratch. Then, the following chapter explain how to install BrainVISA starting from this base system.

===========================================
II - How to create a base casa system image
===========================================

The base casa system image is a minimal configuration of a system image downloaded from internet as an *.iso file. It serves as starting point for the building of user images and developer images. The BrainVISA team will support only two base system images at one time :

  1) The release image that is used whenever a stable distribution is created.
  2) The release candidate image that is used to build unstable distributions that are not supported and must be used only for testing purpose.

The base casa system image is part of the casa release plan. Whenever a release is done, it is decided if the release candidate image becomes the new release image. If yes, the release candidate image replaces the release image and the previous release image may be destroyed.


officially published at the time of a casa release. Whene
In this chapter we will use Ubuntu 18.04 as a base system in VirtualBox but it can be easily adapted to another system.

1) Install VirtualBox
2) cd in directory containing this README file
3) create the "vbox" directory that will contain all the VirtualBox image files
4) Download ubuntu-18.04.2-desktop-amd64.iso in the current directory
5) launch the script create_ubuntu-18.04_vm.sh to create an empty VirtualBox image with appropriate base settings
6) Perform Ubuntu minimal installation with an autologin account named "brainvisa" and with password "brainvisa"
7) Perform system updates
8) Set root password to "brainvisa" (this is necessary to automatically connect to the VM to perform post-install)
9) Reboot the VM
10) Install compilation packages : sudo apt install build-essential 
11) Download and install VirtualBox guest additions
12) Shut down the VM
13) Configure the VM in VirualBox (especially 3D acceleration, processors and memory)

==========================================
III - Create and install a BrainVISA image
==========================================

To create an image, it is necessary to have a casa_distro build workflow using the same system as the target image (in our case Ubuntu 18.04). From this build workflow, the content of the /casa/src and /casa/build directories will be copied to the VirtualBox image. Therefore, one must have previously create all what is necessary to be included in the image. For instance, launch:

  casa_distro create distro_source=brainvisa system=ubuntu-18.04 branch=bug_fix
  casa_distro bv_maker distro=brainvisa system=ubuntu-18.04 branch=bug_fix
  
Then the rest of the procedure consist on :
1) Cloning the base system image
2) Installing dependencies (with the same scripts used for Docker)
3) Copying build tree and sources in image

This procedure is written in post_install_ubuntu-18.04.sh. This file is not yet ready for automatic running (especially because the code to wait for a virtual machine to start is not written).

At the time of this writing, it is necessary to explicitely use bv_env to run our software in the VM (e.g /casa/build/bin/bv_env anatomist).
