#! /usr/bin/env python

from __future__ import print_function

import argparse
from getpass import getpass
import sys
import zipfile
import tempfile
import shutil
import os
import os.path as osp

commands = []
def command(f):
    global commands
    commands.append(f.__name__)
    return f

default_build_workflow_repository = '/neurospin/cati/Users/cointepas/casa_distro'
default_repository_server = 'catidev.cea.fr'
default_repository_server_directory = 'casa_distro'
default_repository_login = 'casa'


@command
def package_casa_distro(build_workflows_repository=default_build_workflow_repository):
    '''Create a casa_distro.zip containing a usable version of casa_distro'''
    import casa_distro
    import brainvisa.maker
    import tempfile
    import shutil
    import zipfile
    import os
    import os.path as osp
    from fnmatch import fnmatch
    
    from casa_distro.info import __version__ as casa_distro_version

    dirs = {
        osp.dirname(casa_distro.__file__): ('casa_distro', '*.py'),
        osp.dirname(brainvisa.maker.__file__): ('brainvisa/maker', '*.py'),
        casa_distro.share_directory: ('share', None),
    }
    tmp = tempfile.mkdtemp()
    try:
        # Copy files in temporary directory
        os.mkdir(osp.join(tmp,'brainvisa'))
        open(osp.join(tmp, 'brainvisa', '__init__.py'), 'w')
        shutil.copy(__file__, osp.join(tmp, '__main__.py'))
        for srcdir, dstdir_filter in dirs.items():
            dstdir, filter = dstdir_filter
            os.mkdir(osp.join(tmp, dstdir))
            len_srcdir = len(srcdir) + 1
            for dirpath, dirnames, filenames in os.walk(srcdir):
                zipdir = osp.join(dstdir, dirpath[len_srcdir:])
                for i in dirnames:
                    os.mkdir(osp.join(tmp, zipdir, i))
                for i in filenames:
                    if not filter or fnmatch(i, filter):
                        shutil.copy(osp.join(dirpath, i), osp.join(tmp, zipdir, i))

        # Create zip archive of temporary directory
        with zipfile.ZipFile(osp.join(build_workflows_repository, 'casa_distro-%s.zip' % casa_distro_version), mode='w') as zip:
            len_tmp = len(tmp)+1
            for dirpath, dirnames, filenames in os.walk(tmp):
                zipdir = dirpath[len_tmp:]
                for i in filenames:
                    f = zip.write(osp.join(dirpath,i), osp.join(zipdir,i))
    finally:
        shutil.rmtree(tmp)

@command
def publish_casa_distro(build_workflows_repository=default_build_workflow_repository, 
                        repository_server=default_repository_server, 
                        repository_server_directory=default_repository_server_directory,
                        login=default_repository_login, verbose=None):
    '''Publish casa_distro.zip file previously created with package_casa_distro to the sftp server'''
    from subprocess import check_call
    
    from casa_distro.info import __version__ as casa_distro_version
    
    
    lftp_script = tempfile.NamedTemporaryFile()
    if login:
        remote = 'sftp://%s@%s' % (login, repository_server)
    else:
        remote = 'sftp://%s' % repository_server
    print('connect', remote, file=lftp_script)
    print('cd', repository_server_directory, file=lftp_script)
            
    print('put %s/casa_distro-%s.zip' % (build_workflows_repository, casa_distro_version), file=lftp_script)
    print('rm -f casa_distro.zip', file=lftp_script)
    print('ln -s casa_distro-%s.zip casa_distro.zip' % casa_distro_version, file=lftp_script)
    lftp_script.flush()
    cmd = ['lftp', '-f', lftp_script.name]
    if verbose:
        print('Running', *cmd, file=verbose)
        print('-' * 10, lftp_script.name, '-'*10, file=verbose)
        print(open(lftp_script.name).read(), file=verbose)
        print('-'*40, file=verbose)
    check_call(cmd)
    

@command
def create_release_plan(components=None, build_workflows_repository=default_build_workflow_repository, verbose=None):
    '''create a release plan file by reading sources.'''
    from casa_distro.bv_maker import inspect_components_and_create_release_plan
    import yaml # TODO move related code into bv_maker.py
    
    if components:
        components = components.split(',')
    release_plan_file = open(osp.join(build_workflows_repository, 'release_plan.yaml'), 'w')
    release_plan = inspect_components_and_create_release_plan(components, verbose=verbose)
    print(yaml.dump(release_plan, default_flow_style=False), file=release_plan_file)


@command
def publish_release_plan(login, password=None, build_workflows_repository=default_build_workflow_repository, verbose=None):
    '''send information to the CASA forum about things that would be done with the release plan file'''
    from casa_distro.bv_maker import publish_release_plan_on_wiki
    if password is None:
        password = getpass('BioProj password for %s: ' % login)
    release_plan_file = osp.join(build_workflows_repository, 'release_plan.yaml')
    publish_release_plan_on_wiki(login, password, release_plan_file)


@command
def apply_release_plan(login, password=None, build_workflows_repository=default_build_workflow_repository, verbose=None):
    '''apply actions defined in release plan file'''
    print('ERROR: command cmd_apply_release_plan is not implemented', file=sys.stderr)
    sys.exit(1)


@command
def create_docker(verbose=None):
    '''create or update all casa-test and casa-dev docker images'''
    from casa_distro.docker import create_docker_images
    create_docker_images()


@command
def publish_docker(verbose=None):
    '''publish docker images on dockerhub.com for public images or sandbox.brainvisa.info for private images'''
    from casa_distro.docker import publish_docker_images
    publish_docker_images()


@command
def create_build_workflow(distro='opensource', branch='latest_release', system=None, download=False, build_workflows_repository=default_build_workflow_repository, verbose=None):
    '''create a new build workflow directory in a repository of build workflows'''
    from casa_distro.docker import create_build_workflow
    if download:
        print('ERROR: download option of create_build_workflow is not implemented', file=sys.stderr)
        sys.exit(1)
    else:
        create_build_workflow(build_workflows_repository, distro=distro, branch=branch, system=system)


@command
def list_build_workflows(distro='*', branch='*', system='*', 
                         build_workflows_repository=default_build_workflow_repository,
                         verbose=None):
    '''List (eventually selected) build workflows created by create_build_workflow.'''
    from casa_distro import iter_build_workflow
    
    for d, b, s, bwf_dir in iter_build_workflow(build_workflows_repository, distro=distro, branch=branch, system=system):
        print('distro=%s' % d,'branch=%s' % b, 'system=%s' % s)
        print('  directory:', bwf_dir)

@command
def pull_build_workflows(distro='*', branch='*', system='*', 
                         build_workflows_repository=default_build_workflow_repository, 
                         repository_server=default_repository_server, 
                         repository_server_directory=default_repository_server_directory,
                         login=default_repository_login, verbose=None):
    '''Download a build workflow (except conf directory) from sftp server (require lftp command to be installed).'''
    from subprocess import check_call
    from casa_distro import iter_build_workflow
    
    lftp_script = tempfile.NamedTemporaryFile()
    if login:
        remote = 'sftp://%s@%s' % (login, repository_server)
    else:
        remote = 'sftp://%s' % repository_server
    print('connect', remote, file=lftp_script)
    print('cd', repository_server_directory, file=lftp_script)
    for d, b, s, bwf_dir in iter_build_workflow(build_workflows_repository, distro=distro, branch=branch, system=system):
        relative_bwf_dir = bwf_dir[len(build_workflows_repository)+1:]
        for d in ('src', 'build', 'install', 'pack'):
            cmd = ['mirror', osp.join(relative_bwf_dir,d), osp.join(bwf_dir,d)]
            if verbose:
                cmd.insert(2, '-v')
            print(*cmd, file=lftp_script)
    lftp_script.flush()
    cmd = ['lftp', '-f', lftp_script.name]
    if verbose:
        print('Running', *cmd, file=verbose)
        print('-' * 10, lftp_script.name, '-'*10, file=verbose)
        print(open(lftp_script.name).read(), file=verbose)
        print('-'*40, file=verbose)
    check_call(cmd)


@command
def publish_build_workflows(distro='*', branch='*', system='*', 
                            build_workflows_repository=default_build_workflow_repository, 
                            repository_server=default_repository_server, 
                            repository_server_directory=default_repository_server_directory,
                            login=default_repository_login, verbose=None):
    '''Upload a build workflow to sftp server (require lftp command to be installed).'''
    
    from subprocess import check_call
    from casa_distro import iter_build_workflow
    
    lftp_script = tempfile.NamedTemporaryFile()
    if login:
        remote = 'sftp://%s@%s' % (login, repository_server)
    else:
        remote = 'sftp://%s' % repository_server
    print('connect', remote, file=lftp_script)
    print('cd', repository_server_directory, file=lftp_script)
    for bwf_dir in iter_build_workflow(build_workflows_repository, distro=distro, branch=branch, system=system):
        relative_bwf_dir = bwf_dir[len(build_workflows_repository)+1:]
        
        cmd = ['mirror', '-R', '--delete', bwf_dir, relative_bwf_dir]
        if verbose:
            cmd.insert(2, '-v')
        print(*cmd, file=lftp_script)
    lftp_script.flush()
    cmd = ['lftp', '-f', lftp_script.name]
    if verbose:
        print('Running', *cmd, file=verbose)
        print('-' * 10, lftp_script.name, '-'*10, file=verbose)
        print(open(lftp_script.name).read(), file=verbose)
        print('-'*40, file=verbose)
    check_call(cmd)

@command
def shell(distro='opensource', branch='latest_release', system=None,
          build_workflows_repository=default_build_workflow_repository,
          X=False, args_list=[]):
    '''Start a bash shell in Docker with the given repository configuration.'''
    from casa_distro.docker import run_docker_shell
    run_docker_shell(build_workflows_repository, distro=distro, branch=branch,
                     system=system, X=X, args_list=args_list)

@command
def bv_maker(distro='opensource', branch='latest_release', system=None,
             build_workflows_repository=default_build_workflow_repository,
             X=False, args_list=[]):
    '''Start bv_maker in Docker with the given repository configuration.'''
    from casa_distro.docker import run_docker_bv_maker
    run_docker_bv_maker(build_workflows_repository, distro=distro,
                        branch=branch, system=system, X=X, args_list=args_list)


@command
def run(distro='opensource', branch='latest_release', system=None,
        build_workflows_repository=default_build_workflow_repository,
        args_list=[], X=False, *args):
    '''Start any command in Docker with the given repository configuration.
    Command and args should be specified after --:
    casa_distro -r /home/casa run branch=bug_fix -- ls -als /casa'''
    from casa_distro.docker import run_docker
    run_docker(build_workflows_repository, distro, branch, system, X,
               *args_list)


@command
def help(command):
    '''print help about a command'''
    command_help = globals()[command].__doc__
    print(command_help)

if __name__ == '__main__':    
    class ArgumentLineBreakFormatter(argparse.HelpFormatter):
        def _split_lines(self, text, width):
            result = []
            lines = text.split('\n')
            for line in lines:
                if line:
                    result.extend(super(ArgumentLineBreakFormatter, self)._split_lines(line, width))
                else:
                    result.append('')
            return result

    args_list = []
    if '--' in sys.argv:
        ind = sys.argv.index('--')
        args_list = sys.argv[ind + 1:]
        sys.argv = sys.argv[:ind]

    parser = argparse.ArgumentParser(description='Casa distribution creation tool',
                                     formatter_class=ArgumentLineBreakFormatter)

    parser.add_argument('-r', '--repository', default=None,
                        help='Path of the directory containing build workflow (default=/neurospin/cati/casa_distro)')
    parser.add_argument('-v', '--verbose', action='store_true',
                        help='Display information during processing')
    parser.add_argument('command', nargs=1, choices=commands,
                        help='\n\n'.join('"%s": %s;\n\n' % (i, globals()[i].__doc__) for i in commands))
    parser.add_argument('command_options', nargs='*',
                        help='command specific options (use help <command> to list these options).')
    options = parser.parse_args()

    tmp_share = None
    try:
        # Manage share directory in Zip file distribution
        if not osp.exists(__file__) and osp.dirname(__file__).endswith('.zip'):
            tmp_share = tempfile.mkdtemp()
            with zipfile.ZipFile(osp.dirname(__file__)) as zip:
                for i in zip.namelist():
                    if i.startswith('share'):
                        zip.extract(i, tmp_share)
            import casa_distro
            casa_distro.share_directory = osp.join(tmp_share, 'share')

        command = globals()[options.command[0]]
        args = []
        kwargs = {}
        if options.verbose:
            kwargs['verbose'] = sys.stdout
        if options.repository:
            kwargs['build_workflows_repository'] = options.repository
        for i in options.command_options:
            l = i.split('=', 1)
            if len(l) == 2:
                kwargs[l[0]] = l[1]
            else:
                args.append(i)
        if len(args_list) != 0:
            kwargs['args_list'] = args_list
        command(*args, **kwargs)
    finally:
        if tmp_share:
            shutil.rmtree(tmp_share)
